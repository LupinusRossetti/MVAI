# MV Production Automation Agent 操作説明書

> ⚠️ **重要（開発者・AIアシスタント向け）**: このプロジェクトを操作する前に、**必ず以下のファイルを読み込んでください**：
> - **`開発ルール.md`** - **開発者が必ず守るべきルール**（仕様変更時の履歴更新、作業開始前の確認、コミット・プッシュ前の確認など）
> - **`仕様書.md`** - システムの技術仕様、処理フロー、データ形式
> - **`CHANGELOG.md`** - 変更履歴（最新の変更内容を確認）
> - **`.cursorrules`** - Cursor用のプロジェクト固有ルール（開発ルールが埋め込まれています）
> 
> これらのファイルを読み込まないと、開発ルールに違反する可能性があります。

## 目次
1. [初回セットアップ](#初回セットアップ)
2. [基本的な使い方](#基本的な使い方)
3. [各機能の詳細説明](#各機能の詳細説明)
4. [ワークフロー例](#ワークフロー例)
5. [よくある質問](#よくある質問)

---

## 初回セットアップ

### 1. 必要なソフトウェアのインストール

#### Pythonのインストール
1. [Python公式サイト](https://www.python.org/downloads/)からPython 3.8以上をダウンロード
2. インストール時に「Add Python to PATH」にチェックを入れる

#### FFmpegのインストール
1. [FFmpeg公式サイト](https://ffmpeg.org/download.html)からダウンロード
2. または、Chocolateyを使用している場合: `choco install ffmpeg`

#### 依存ライブラリのインストール
```bash
cd C:\MVAI
pip install -r requirements.txt
```

### 2. アプリケーションの起動

**方法1: バッチファイルから起動（推奨）**
1. `start_app.bat`をダブルクリック
2. ブラウザが自動的に開きます

**方法2: コマンドラインから起動**
```bash
cd C:\MVAI
streamlit run app.py
```

### 3. Gemini API Keyの設定

1. [Google AI Studio](https://aistudio.google.com/)にアクセス
2. アカウントでログイン
3. 「Get API Key」をクリックしてAPI Keyを生成
4. アプリケーションのサイドバーで「🔑 API Keyを設定」をクリック
5. 生成したAPI Keyを入力
6. API Keyは自動的に保存され、次回起動時も使用されます

---

## 基本的な使い方

### アプリケーションの構成

アプリケーションは以下のタブで構成されています：

1. **🤖 プロンプト生成** - AIツール用のプロンプトを作成
2. **📝 プロンプト履歴** - 過去に生成したプロンプトを確認
3. **🎬 動画処理** - 動画の高品質化、リップシンク、最終処理
4. **🎵 MV自動生成** - 複数の動画クリップからMVを生成
5. **📊 ステータス/ログ** - 処理ログを確認
6. **📁 フォルダ構成** - フォルダの状態を確認

### 基本的なワークフロー

```
1. プロンプト生成 → 2. AIツールで素材生成 → 3. フォルダに配置 → 4. 自動処理 → 5. MV生成
```

---

## 各機能の詳細説明

### 🤖 プロンプト生成

#### 1. プロンプトタイプの選択

以下の4種類から選択できます：

- **🎵 曲を生成するためのプロンプト（Suno AI用）**
  - 音楽生成AI「Suno AI」で使用するプロンプトを作成
  - ジャンル、テンポ、ムード、楽器、ボーカルスタイル、曲構成を選択

- **🎬 MVの1シーンを作成するプロンプト（Sora/Grok/Luma用）**
  - 動画生成AI（Sora、Grok、Luma等）で使用するプロンプトを作成
  - キャラクター、カメラワーク、照明、ムード、被写体の動き、背景を選択

- **🖼️ 動画シーンの基となる画像を作成するプロンプト（Grok Scene用）**
  - 画像生成AI「Grok Scene」で使用するプロンプトを作成
  - キャラクター、スタイル、構図、背景を選択

- **👤 一貫性のあるキャラクター画像を作成するプロンプト（Gemini 3 / Adobe Firefly用）**
  - キャラクター画像生成用のプロンプトを作成
  - nanobanana pro形式（Positive/Negativeプロンプト）で出力
  - I2I（既存画像から）または新規作成を選択可能

#### 2. 対話形式での選択

1. プロンプトタイプを選択
2. 各項目の選択肢から希望を選択
3. 「次へ」ボタンで次の項目へ進む
4. 「戻る」ボタンで前の項目に戻る
5. 選択履歴をクリックすると、その項目に直接戻れます

#### 3. プロンプトの生成

1. すべての項目を選択
2. 「プロンプトを生成」ボタンをクリック
3. 生成されたプロンプトが表示されます
4. プロンプトをコピーして、各AIツールで使用

#### 4. キャラクター管理

**サイドバーの「キャラクター管理」セクションで：**

- **キャラクター画像のアップロード**
  1. 「キャラクター名」を入力
  2. 「画像をアップロード」で画像を選択
  3. 「キャラクターを追加」をクリック
  4. 同名のキャラクターは同じフォルダに保存されます

- **キャラクター一覧の確認**
  - 登録済みのキャラクター名が表示されます
  - キャラクターを選択すると、プロンプト生成時に属性が自動的に読み込まれます

### 📝 プロンプト履歴

#### 履歴の確認
- 過去に生成したプロンプトが最大10件まで表示されます
- 各履歴には以下が含まれます：
  - プロンプトタイプ
  - 生成日時
  - 生成されたプロンプト
  - 選択した内容（JSON形式）

#### お気に入り機能
- 「⭐ お気に入りに追加」ボタンでお気に入りに追加
- 「⭐ お気に入りプロンプト」セクションで確認
- 「🗑️ お気に入りから削除」で削除

### 🎬 動画処理（手動）

#### 処理タイプの選択

1. **高品質化処理（04_AI動画_生成中 → 05_動画_高品質化）**
   - AI生成動画を高品質化
   - 解像度を2倍にアップスケール（最大4K）
   - フレームレートを補間（30fps以下→60fps）

2. **リップシンク処理（05_動画_高品質化 → 06_動画_口パク）**
   - 高品質化済み動画にリップシンク処理
   - 現在はコピーのみ（実際のリップシンク処理は未実装）

3. **最終処理（06_動画_口パク → 99_MV_編集素材 + XML生成）**
   - リップシンク済み動画を最終処理
   - XMLメタデータを生成
   - セットフォルダを作成

#### 動画の選択と処理

1. 処理タイプを選択
2. 動画ファイル一覧から処理したい動画を選択（複数選択可）
3. サムネイルが表示されます
4. 「選択した動画を処理」ボタンをクリック
5. 処理が完了すると、ログに結果が表示されます

**注意**: 「使用済み素材」フォルダの動画も選択できます。使用後も使用済みフォルダに残ります。

### 🎵 MV自動生成

#### MV生成の手順

1. **動画クリップの選択**
   - 「リップシンク済み動画を使用する」にチェックを入れると、`06_動画_口パク`フォルダから選択
   - チェックを外すと、ソースフォルダを選択できます：
     - 04_AI動画_生成中（未処理）
     - 05_動画_高品質化（高品質化済み）
     - 06_動画_口パク（リップシンク済み）
     - 99_MV_編集素材（最終処理済み）

2. **動画クリップの選択**
   - 表示された動画ファイル一覧から、MVに使用する動画を選択（複数選択可）
   - 「使用済み素材」フォルダの動画も選択可能

3. **音声ファイルの選択**
   - `99_MV_編集素材/音声ファイル/`から音声ファイルを選択
   - 音声ファイルがない場合は、`01_曲_Input`フォルダに音声ファイルを配置してください

4. **MV生成設定**
   - 出力ファイル名を入力（拡張子なし）
   - 「ビートに同期する」にチェックを入れると、シーンの切り替えがビートに合わせられます

5. **MV生成**
   - 「🚀 MVを生成」ボタンをクリック
   - 処理が完了すると、`98_MV_完成品`フォルダに保存されます

### 📊 ステータス/ログ

- 処理ログが時系列で表示されます
- 成功: 緑色、エラー: 赤色、情報: 青色
- 「ログをクリア」ボタンでログをクリア

### 📁 フォルダ構成

- 各フォルダの存在確認
- ファイル数とフォルダ数の表示
- サブフォルダも含めてカウント

---

## ワークフロー例

### 例1: 基本的なMV制作

1. **プロンプト生成**
   - 「🎵 曲を生成するためのプロンプト」を選択
   - 各項目を選択してプロンプトを生成
   - Suno AIで曲を生成

2. **音声ファイルの配置**
   - 生成した曲を`01_曲_Input`フォルダに配置
   - 自動的にBPMとビートタイミングが解析されます

3. **動画プロンプト生成**
   - 「🎬 MVの1シーンを作成するプロンプト」を選択
   - 各項目を選択してプロンプトを生成
   - Sora/Grok/Lumaで動画を生成

4. **動画の高品質化**
   - 生成した動画を`04_AI動画_生成中`フォルダに配置
   - 「🎬 動画処理」タブで高品質化処理を実行
   - または、自動処理をONにしている場合は自動で処理されます

5. **リップシンク処理**
   - 「🎬 動画処理」タブでリップシンク処理を実行

6. **MV生成**
   - 「🎵 MV自動生成」タブで動画クリップと音声を選択
   - 「ビートに同期する」にチェック
   - MVを生成

### 例2: キャラクター画像の一貫性を保つ

1. **キャラクター画像の登録**
   - サイドバーの「キャラクター管理」でキャラクター画像をアップロード

2. **キャラクター画像プロンプト生成**
   - 「👤 一貫性のあるキャラクター画像を作成するプロンプト」を選択
   - 「既存のキャラクター画像を使用する（I2I）」を選択
   - 登録したキャラクターを選択
   - 変更したい項目のみ選択（「指定なし(既存のまま)」はプロンプトに含まれません）

3. **プロンプトの使用**
   - 生成されたプロンプトをAdobe FireflyやGemini 3で使用
   - 一貫性のあるキャラクター画像を生成

---

## よくある質問

### Q1: 高品質化処理に時間がかかります
**A**: 高品質化処理は解像度とフレームレートによって処理時間が変わります。4K解像度、60fpsの動画は数分かかる場合があります。

### Q2: リップシンク処理が実際に動作していません
**A**: 現在のリップシンク処理はファイルコピーのみです。実際のリップシンク処理を実装する場合は、Wav2LipやSadTalkerなどのツールを統合する必要があります。

### Q3: 使用済み素材フォルダの動画も選択できますか？
**A**: はい、選択できます。使用済み素材フォルダの動画を使用した場合、使用後も使用済みフォルダに残ります。

### Q4: プロンプト履歴はどこに保存されますか？
**A**: `.prompt_history.json`と`.favorite_prompts.json`に保存されます。これらのファイルは削除しないでください。

### Q5: API Keyを変更したい
**A**: サイドバーの「🔑 API Keyを変更」ボタンをクリックして、新しいAPI Keyを入力してください。

### Q6: エラーが発生しました
**A**: 「📊 ステータス/ログ」タブでエラーメッセージを確認してください。よくある原因：
- FFmpegがインストールされていない
- 依存ライブラリがインストールされていない
- ファイルが破損している

### Q7: フォルダが自動的に作成されません
**A**: アプリケーションを再起動してください。起動時に自動的にフォルダが作成されます。

### Q8: MV生成時に動画がループしてしまいます
**A**: ビート同期機能を使用している場合、動画の長さが音声のセグメント長に満たない場合、自動的にループされます。より長い動画を使用するか、ビート同期をOFFにしてください。

---

## トラブルシューティング

### アプリケーションが起動しない
1. Pythonがインストールされているか確認: `python --version`
2. 依存ライブラリを再インストール: `pip install -r requirements.txt`
3. Streamlitを再インストール: `pip install --upgrade streamlit`

### FFmpegエラーが発生する
1. FFmpegがインストールされているか確認: `ffmpeg -version`
2. FFmpegがPATHに追加されているか確認
3. FFmpegを再インストール

### 処理が完了しない
1. 「📊 ステータス/ログ」タブでエラーメッセージを確認
2. ファイルが破損していないか確認
3. ディスク容量が十分か確認

### プロンプトが生成されない
1. API Keyが正しく設定されているか確認
2. インターネット接続を確認
3. Gemini APIのクォータを確認

---

## サポート

問題が解決しない場合は、以下を確認してください：
- ログファイル（`99_Logs/`フォルダ）
- エラーメッセージの詳細
- 使用しているファイルの形式とサイズ

