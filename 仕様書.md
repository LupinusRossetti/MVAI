# MV Production Automation Agent 仕様書

> ⚠️ **重要**: このプロジェクトを操作する前に、**必ず以下のファイルを読み込んでください**：
> - **`開発ルール.md`** - 開発者が必ず守るべきルール（仕様変更時の履歴更新、作業開始前の確認、コミット・プッシュ前の確認など）
> - **`CHANGELOG.md`** - 変更履歴（最新の変更内容を確認）
> - **`README.md`** - プロジェクト概要と開発ルールへのリンク
> 
> これらのファイルを読み込まないと、開発ルールに違反する可能性があります。

## 1. システム概要

### 1.1 目的
MV Production Automation Agentは、ルピナス、アイリス、フィオナの三姉妹によるMV制作を支援する自動化パイプラインアプリケーションです。手動でのAI生成作業とローカルでのメディア処理を分離し、監督がクリエイティブな判断に集中できる環境を提供します。

### 1.2 アーキテクチャ
- **フロントエンド**: Streamlit（Web UI）
- **バックエンド**: Python 3.x
- **メディア処理**: FFmpeg、Librosa
- **AI API**: Google Gemini API

### 1.3 主要コンポーネント
- `app.py`: メインアプリケーション（UI、ファイル監視）
- `media_processor.py`: メディア処理エンジン
- `prompt_generator.py`: AIプロンプト生成
- `prompt_dialogs.py`: 対話形式プロンプト生成UI
- `character_manager.py`: キャラクター画像管理
- `prompt_history.py`: プロンプト履歴管理

## 2. フォルダ構造と処理フロー

### 2.1 フォルダ構成

```
C:\MVAI\
├── 00_キャラクター/          # キャラクター画像管理
│   └── [キャラクター名]/
│       └── [画像ファイル]
├── 01_曲_Input/              # 音声ファイル入力
├── 02_元動画_Sora/           # 元動画入力（Adobe Sora/Firefly）
├── 03_静止画_選定/           # キーフレーム自動抽出結果
├── 04_AI動画_生成中/         # AI生成動画入力
│   └── 使用済み素材/         # 処理済み素材
├── 05_動画_高品質化/         # 高品質化処理済み動画
│   └── 使用済み素材/         # 処理済み素材
├── 06_動画_口パク/           # リップシンク処理済み動画
│   └── 使用済み素材/         # 処理済み素材
├── 98_MV_完成品/             # 完成したMVの出力先
├── 99_MV_編集素材/           # 最終処理済み素材
│   ├── [動画名]/             # 動画ごとのセットフォルダ
│   │   ├── [動画ファイル].mp4
│   │   └── [動画名]_metadata.xml
│   └── 音声ファイル/         # 処理済み音声ファイル
└── 99_Logs/                  # 解析ログCSV、処理ログ
```

### 2.2 処理フロー

#### 音声処理フロー
```
01_曲_Input/音声ファイル
    ↓
[BPM・ビートタイミング解析] (librosa)
    ↓
99_Logs/[曲名]_beats.csv (出力)
    ↓
99_MV_編集素材/音声ファイル/ (移動)
```

#### 動画処理フロー
```
02_元動画_Sora/動画ファイル
    ↓
[静止画抽出] (ffmpeg)
    ↓
03_静止画_選定/ (出力)
```

#### AI動画処理フロー
```
04_AI動画_生成中/動画ファイル
    ↓
[高品質化処理]
    ├─ 解像度アップスケール (2倍、最大4K)
    ├─ フレームレート補間 (30fps以下→60fps)
    └─ 高品質エンコード (CRF18, preset=slow)
    ↓
05_動画_高品質化/[動画名]_hq.mp4
    ↓
[リップシンク処理] (現在はコピーのみ)
    ↓
06_動画_口パク/[動画名]_lipsync.mp4
    ↓
[最終処理]
    ├─ XMLメタデータ生成
    └─ セットフォルダ作成
    ↓
99_MV_編集素材/[動画名]/
    ├─ [動画ファイル].mp4
    └─ [動画名]_metadata.xml
```

#### MV生成フロー
```
06_動画_口パク/動画クリップ (複数)
    ↓
[動画結合] (ffmpeg)
    ↓
[音声追加] (99_MV_編集素材/音声ファイル)
    ↓
[ビート同期] (99_Logs/beats.csv)
    ↓
98_MV_完成品/MV_[日時].mp4
```

## 3. 機能仕様

### 3.1 プロンプト生成機能

#### 3.1.1 対応プロンプトタイプ
1. **Suno AI用プロンプト**
   - ジャンル、テンポ、ムード、楽器、ボーカルスタイル、曲構成を選択
   - 対話形式で段階的に選択

2. **Sora/Grok/Luma用プロンプト**
   - キャラクター、カメラワーク、照明、ムード、被写体の動き、背景を選択
   - 既存キャラクターの属性を自動読み込み

3. **Grok Scene用プロンプト**
   - 画像生成用プロンプト
   - キャラクター、スタイル、構図、背景を選択

4. **キャラクター画像生成用プロンプト**
   - nanobanana pro形式（Positive/Negativeプロンプト）
   - I2I（既存画像から）または新規作成
   - 髪型、色、服装、ポーズ、背景など詳細な選択肢

#### 3.1.2 プロンプト履歴機能
- 最大10件の履歴を自動保存
- 選択内容も一緒に保存
- お気に入り機能（別ファイルに保存）

### 3.2 メディア処理機能

#### 3.2.1 音声処理 (`process_audio_file`)
- **入力**: `01_曲_Input/` の音声ファイル（.mp3, .wav, .flac, .m4a, .aac, .ogg, .wma）
- **処理内容**:
  - BPM検出（librosa.beat.beat_track）
  - ビートタイミング抽出（秒単位）
  - CSV出力（`99_Logs/[曲名]_beats.csv`）
- **出力**: `99_MV_編集素材/音声ファイル/` に移動

#### 3.2.2 動画処理 (`process_video_file`)
- **入力**: `02_元動画_Sora/` の動画ファイル
- **処理内容**:
  - 動画情報取得（ffmpeg.probe）
  - 等間隔で静止画抽出（最大10枚）
  - 高動作シーンを優先的に抽出
- **出力**: `03_静止画_選定/` にJPG形式で保存

#### 3.2.3 高品質化処理 (`trigger_quality_pipeline`)
- **入力**: `04_AI動画_生成中/` の動画ファイル
- **処理内容**:
  1. **解像度アップスケール**
     - 元の解像度を2倍に拡大（最大4K: 3840×2160）
     - アスペクト比を維持
     - 偶数に調整（エンコーダー要件）
  
  2. **フレームレート補間**
     - 30fps以下 → 60fpsに補間
     - `minterpolate`フィルター使用
     - モーションベース補間（mi_mode='mci'）
     - 適応的オーバーラップブロックモーション補償（mc_mode='aobmc'）
  
  3. **高品質エンコード**
     - コーデック: libx264
     - プリセット: slow（高品質重視）
     - CRF: 18（高品質）
     - ピクセルフォーマット: yuv420p
     - Web再生最適化: faststart
- **出力**: `05_動画_高品質化/[動画名]_hq.mp4`
- **元ファイル**: `04_AI動画_生成中/使用済み素材/` に移動（使用済み素材フォルダの動画は移動しない）

#### 3.2.4 リップシンク処理 (`process_lipsync`)
- **入力**: `05_動画_高品質化/` の動画ファイル
- **処理内容**: 現在はファイルコピーのみ（実際のリップシンク処理は未実装）
- **出力**: `06_動画_口パク/[動画名]_lipsync.mp4`
- **元ファイル**: `05_動画_高品質化/使用済み素材/` に移動（使用済み素材フォルダの動画は移動しない）

#### 3.2.5 最終処理 (`finalize_assets`)
- **入力**: `06_動画_口パク/` の動画ファイル
- **処理内容**:
  1. 動画情報取得（解像度、フレームレート、コーデックなど）
  2. XMLメタデータ生成
     - ファイル情報
     - 動画情報（コーデック、解像度、フレームレート、ビットレート）
     - 音声情報（コーデック、サンプルレート、チャンネル数）
     - 処理履歴（高品質化、リップシンク、最終処理日時）
  3. セットフォルダ作成（動画ファイル名をベースに）
- **出力**: 
  - `99_MV_編集素材/[動画名]/[動画ファイル].mp4`
  - `99_MV_編集素材/[動画名]/[動画名]_metadata.xml`
- **元ファイル**: 
  - 通常の動画: `06_動画_口パク/使用済み素材/` に移動してからコピー
  - 使用済み素材フォルダの動画: コピーのみ（元の場所に残す）

### 3.3 MV自動生成機能

#### 3.3.1 動画クリップ結合 (`combine_video_clips`)
- **入力**: 複数の動画ファイルパス
- **処理内容**:
  - 解像度とフレームレートを統一（最初のクリップに合わせる）
  - FFmpeg concat demuxerで結合
- **出力**: 結合された動画ファイル

#### 3.3.2 MV生成 (`create_mv_from_clips`)
- **入力**: 
  - 動画クリップリスト
  - 音声ファイルパス
  - 出力パス
  - ビート同期フラグ
- **処理内容**:
  1. 音声ファイルの長さを取得
  2. ビートデータ読み込み（`99_Logs/[曲名]_beats.csv`）
  3. ビート同期モードの場合:
     - 4ビートごとにセグメント分割
     - 各セグメントに動画クリップを割り当て
     - 動画をループまたはトリミングしてセグメント長に合わせる
  4. 動画と音声を結合
  5. 解像度とフレームレートを統一
- **出力**: `98_MV_完成品/MV_[日時].mp4`

### 3.4 ファイル監視機能

#### 3.4.1 Watchdog監視
- **監視対象フォルダ**:
  - `01_曲_Input/`
  - `02_元動画_Sora/`
  - `04_AI動画_生成中/`
  - `05_動画_高品質化/`
  - `06_動画_口パク/`
- **動作**: ファイル追加時に自動処理をトリガー
- **手動ON/OFF**: UIから切り替え可能

### 3.5 キャラクター管理機能

#### 3.5.1 キャラクター画像管理
- **保存場所**: `00_キャラクター/[キャラクター名]/`
- **機能**:
  - 画像アップロード
  - 同名キャラクターは同じフォルダに保存
  - 同名ファイルは自動番号付け（(1), (2)...）
  - キャラクター属性の保存（.characters.json）

#### 3.5.2 キャラクター属性の利用
- プロンプト生成時に既存キャラクターを選択すると、属性が自動的に読み込まれる
- 選択肢のデフォルト値として使用

## 4. 技術仕様

### 4.1 使用ライブラリ
- **Streamlit**: 1.28.0以上
- **watchdog**: ファイルシステム監視
- **librosa**: 音声解析
- **ffmpeg-python**: 動画処理
- **google-generativeai**: Gemini API
- **pandas**: データ処理
- **Pillow**: 画像処理

### 4.2 外部依存
- **FFmpeg**: システムにインストール必須
- **Python**: 3.8以上

### 4.3 API仕様
- **Gemini API**: 
  - モデル: gemini-1.5-flash-latest（優先）、gemini-1.5-pro-latest、gemini-pro（フォールバック）
  - API Key: `.api_key.json`に保存（Git管理外）

### 4.4 データ形式

#### 4.4.1 ビートデータCSV
```csv
beat_time_seconds,beat_index
0.0,0
0.5,1
1.0,2
...
```

#### 4.4.2 XMLメタデータ
```xml
<MVAsset version="1.0">
  <Info>
    <FileName>動画ファイル名.mp4</FileName>
    <OriginalFileName>元のファイル名.mp4</OriginalFileName>
    <ProcessedDate>2025-11-30T20:00:00</ProcessedDate>
  </Info>
  <Video>
    <Codec>h264</Codec>
    <Width>3840</Width>
    <Height>2160</Height>
    <FrameRate>60/1</FrameRate>
    <Duration>6.0</Duration>
    <Bitrate>5000000</Bitrate>
  </Video>
  <Audio>
    <Codec>aac</Codec>
    <SampleRate>48000</SampleRate>
    <Channels>2</Channels>
    <Bitrate>128000</Bitrate>
  </Audio>
  <ProcessingHistory>
    <QualityEnhancement>Applied</QualityEnhancement>
    <Lipsync>Applied</Lipsync>
    <Finalized>2025-11-30T20:00:00</Finalized>
  </ProcessingHistory>
</MVAsset>
```

## 5. エラーハンドリング

### 5.1 ファイル処理エラー
- ファイルが存在しない場合: エラーログを出力してスキップ
- ファイルサイズが0の場合: エラーログを出力してスキップ
- 対応していないファイル形式: エラーログを出力してスキップ

### 5.2 APIエラー
- Gemini API呼び出しエラー: エラーメッセージを表示、フォールバックモデルを試行
- API Key未設定: 警告メッセージを表示

### 5.3 メディア処理エラー
- FFmpegエラー: 詳細なエラーメッセージをログに記録
- 処理タイムアウト: 5秒待機後にタイムアウト

## 6. パフォーマンス

### 6.1 処理時間目安
- 音声解析: 数秒（ファイルサイズによる）
- 高品質化処理: 数分（解像度とフレームレートによる）
- リップシンク処理: 数秒（現在はコピーのみ）
- MV生成: 数分（クリップ数と長さによる）

### 6.2 メモリ使用量
- 通常使用時: 数百MB
- 高品質化処理時: 数GB（解像度による）

## 7. セキュリティ

### 7.1 API Key管理
- `.api_key.json`はGit管理外（.gitignoreに追加）
- ローカルファイルに暗号化せず保存（注意が必要）

### 7.2 ファイルアクセス
- 指定されたフォルダ内のみアクセス
- 外部ファイルへのアクセスは行わない

## 8. 今後の拡張予定

### 8.1 未実装機能
- 実際のリップシンク処理（Wav2Lip、SadTalker等の統合）
- より高度な動画編集機能（トランジション、エフェクト）
- バッチ処理機能の強化

### 8.2 改善予定
- 処理の並列化
- プログレスバーの改善
- エラーハンドリングの強化

